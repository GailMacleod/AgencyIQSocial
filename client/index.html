<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

    <link rel="icon" type="image/png" href="/attached_assets/agency_logo_1749083054761.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#3250fa" />
    <link rel="stylesheet" href="/src/index.css" />
    <title>The AgencyIQ</title>
    
    <!-- React CDN for development -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <style>
      body {
        font-family: 'Helvetica', 'Arial', sans-serif; /* Unlicensed, Poppins-like fallback */
        font-weight: 400; /* Matches Poppins' versatility */
        line-height: 1.6;
      }
      h1, h2, h3 {
        font-weight: 700; /* Mimics Poppins' bold weights */
      }
    </style>
    
    <!-- Meta Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '1409057863445071');
      fbq('track', 'PageView');
      console.log('Meta Pixel test fired - initialization complete');
    </script>
    <!-- End Meta Pixel Code -->
    
    <!-- Facebook SDK for JavaScript -->
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId      : '1409057863445071',
          cookie     : true,
          xfbml      : true,
          version    : 'v19.0'
        });
          
        FB.AppEvents.logPageView();   
          
      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "https://connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
    </script>
    <!-- End Facebook SDK -->
    
    <script>
      // AGGRESSIVE console filtering - completely block Replit framework messages
      (function() {
        const originalWarn = console.warn;
        const originalError = console.error;
        const originalLog = console.log;
        
        // Comprehensive filter list for all Replit framework noise
        const frameworkFilters = [
          'Error while parsing the \'sandbox\' attribute',
          'allow-downloads-without-user-activation',
          'Unrecognized feature:',
          'Permissions-Policy',
          'unsized-media',
          'pointer-lock',
          'ambient-light-sensor',
          'battery',
          'execution-while-not-rendered',
          'execution-while-out-of-viewport',
          'layout-animations',
          'legacy-image-formats',
          'navigation-override',
          'oversized-images',
          'publickey-credentials',
          'speaker-selection',
          'unoptimized-images',
          'unsized-media',
          'pointer-lock',
          'Allow attribute will take precedence',
          'allowfullscreen',
          'allowpaymentrequest',
          'Feature Policy',
          'Permissions Policy directive',
          'Unable to preventDefault inside passive event listener invocation',
          'preventDefault inside passive event listener',
          'passive event listener',
          'Cannot notify while not connected',
          'Failed to load resource',
          'Uncaught (in promise) Error: Cannot notify while not connected',
          'Refused to load the font',
          'because it violates the following Content Security Policy directive',
          'font-src',
          'Refused to load the image',
          'createAssignCSP.js',
          'beacon.js',
          'net::ERR_BLOCKED_BY_RESPONSE.NotSameOrigin',
          'workspace_iframe.html',
          '__replco',
          'replit.dev',
          'worf.replit.dev',
          'Understand this warning',
          'vite] server connection lost',
          'Polling for restart'
        ];
        
        function shouldFilter(message) {
          if (typeof message !== 'string') {
            message = String(message);
          }
          return frameworkFilters.some(filter => message.includes(filter));
        }
        
        // Override all console methods to filter Replit framework messages
        console.warn = function(...args) {
          const message = args.join(' ');
          if (!shouldFilter(message)) {
            originalWarn.apply(console, args);
          }
        };
        
        console.error = function(...args) {
          const message = args.join(' ');
          if (!shouldFilter(message)) {
            originalError.apply(console, args);
          }
        };
        
        console.log = function(...args) {
          const message = args.join(' ');
          if (!shouldFilter(message)) {
            originalLog.apply(console, args);
          }
        };
        
        // Suppress window errors from Replit framework
        window.addEventListener('error', function(e) {
          if (shouldFilter(e.message)) {
            e.preventDefault();
            return false;
          }
        });
        
        console.warn = function(...args) {
          if (!shouldFilter(args[0])) {
            originalWarn.apply(console, args);
          }
        };
        
        console.error = function(...args) {
          if (!shouldFilter(args[0])) {
            originalError.apply(console, args);
          }
        };
      })();
    </script>
  </head>
  <body>
    <!-- Meta Pixel noscript fallback -->
    <noscript><img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=1409057863445071&ev=PageView&noscript=1"
    /></noscript>
    
    <div id="root"></div>
    <!-- Block all problematic Replit requests -->
    <script>
      (function() {
        // Block all requests to sp.replit.com/v1/t (tracking endpoint) and beacon.js
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          const url = args[0];
          if (typeof url === 'string') {
            if (url.includes('sp.replit.com/v1/t')) {
              console.log('✅ Blocked Replit tracking request:', url);
              return Promise.resolve(new Response('{"success":true}', { status: 200 }));
            }
            if (url.includes('replit.com') && url.includes('beacon.js')) {
              console.log('✅ Blocked replit.com beacon.js request:', url);
              return Promise.resolve(new Response('// Blocked beacon.js', { status: 200 }));
            }
          }
          return originalFetch.apply(this, args);
        };

        // Block XMLHttpRequest to same endpoints
        const originalXHROpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...args) {
          if (typeof url === 'string') {
            if (url.includes('sp.replit.com/v1/t')) {
              console.log('✅ Blocked XMLHttpRequest to Replit tracking:', url);
              // Change to a safe endpoint
              url = 'data:text/plain,blocked';
            }
            if (url.includes('replit.com') && url.includes('beacon.js')) {
              console.log('✅ Blocked XMLHttpRequest to replit.com beacon.js:', url);
              url = 'data:text/plain,blocked';
            }
          }
          return originalXHROpen.call(this, method, url, ...args);
        };

        // Block navigator.sendBeacon
        const originalSendBeacon = navigator.sendBeacon;
        navigator.sendBeacon = function(url, data) {
          if (typeof url === 'string' && url.includes('sp.replit.com/v1/t')) {
            console.log('✅ Blocked sendBeacon to Replit tracking:', url);
            return true; // Return success
          }
          return originalSendBeacon.call(this, url, data);
        };
      })();
    </script>
    
    <script type="module">
      // TheAgencyIQ React Application
      const { createRoot } = ReactDOM;
      const { useState, useEffect } = React;
      
      // Session management
      async function establishSession() {
        try {
          const response = await fetch('/api/establish-session', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });
          return response.ok;
        } catch (error) {
          console.error('Session establishment failed:', error);
          return false;
        }
      }
      
      // API client with authentication
      async function apiCall(endpoint, options = {}) {
        const response = await fetch(endpoint, {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          ...options
        });
        
        if (!response.ok) {
          const error = await response.text();
          console.error(`API call failed: ${endpoint}`, error);
          throw new Error(`API call failed: ${response.status} ${response.statusText}`);
        }
        
        return response.json();
      }
      
      // Main Dashboard Component
      function Dashboard({ user }) {
        const [platforms, setPlatforms] = useState([]);
        const [loading, setLoading] = useState(true);
        
        useEffect(() => {
          async function loadPlatforms() {
            try {
              const data = await apiCall('/api/platform-connections');
              setPlatforms(data.platforms || []);
            } catch (error) {
              console.error('Failed to load platforms:', error);
            } finally {
              setLoading(false);
            }
          }
          loadPlatforms();
        }, []);
        
        if (loading) {
          return React.createElement('div', { style: { padding: '20px', textAlign: 'center' } }, 
            'Loading dashboard...'
          );
        }
        
        return React.createElement('div', { style: { padding: '20px' } }, [
          React.createElement('h2', { key: 'welcome' }, `Welcome, ${user.email || 'Guest'}`),
          React.createElement('div', { 
            key: 'platforms',
            style: { 
              display: 'grid', 
              gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
              gap: '15px',
              marginTop: '20px'
            }
          }, 
            ['Facebook', 'Instagram', 'LinkedIn', 'X', 'YouTube'].map(platform => {
              const connected = platforms.some(p => p.platform === platform.toLowerCase());
              return React.createElement('div', {
                key: platform,
                style: {
                  padding: '15px',
                  border: '1px solid #ddd',
                  borderRadius: '8px',
                  backgroundColor: connected ? '#e8f5e8' : '#f9f9f9'
                }
              }, [
                React.createElement('h4', { key: 'title' }, platform),
                React.createElement('p', { key: 'status' }, connected ? 'Connected' : 'Not Connected'),
                React.createElement('button', {
                  key: 'button',
                  onClick: () => window.location.href = `/auth/${platform.toLowerCase()}`,
                  style: {
                    padding: '8px 16px',
                    backgroundColor: connected ? '#28a745' : '#007bff',
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: 'pointer'
                  }
                }, connected ? 'Reconnect' : 'Connect')
              ]);
            })
          )
        ]);
      }
      
      // Login Component
      function Login({ onLogin }) {
        const [email, setEmail] = useState('gailm@macleodglba.com.au');
        const [password, setPassword] = useState('');
        const [loading, setLoading] = useState(false);
        
        async function handleLogin(e) {
          e.preventDefault();
          setLoading(true);
          
          try {
            const response = await fetch('/api/login', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password })
            });
            
            if (response.ok) {
              const userData = await response.json();
              onLogin(userData);
            } else {
              alert('Login failed. Please check your credentials.');
            }
          } catch (error) {
            console.error('Login error:', error);
            alert('Login failed. Please try again.');
          } finally {
            setLoading(false);
          }
        }
        
        return React.createElement('div', {
          style: {
            maxWidth: '400px',
            margin: '50px auto',
            padding: '30px',
            border: '1px solid #ddd',
            borderRadius: '8px',
            backgroundColor: '#f9f9f9'
          }
        }, [
          React.createElement('h2', { key: 'title', style: { textAlign: 'center', marginBottom: '20px' } }, 'Login to TheAgencyIQ'),
          React.createElement('form', { key: 'form', onSubmit: handleLogin }, [
            React.createElement('div', { key: 'email-group', style: { marginBottom: '15px' } }, [
              React.createElement('label', { key: 'email-label', style: { display: 'block', marginBottom: '5px' } }, 'Email:'),
              React.createElement('input', {
                key: 'email-input',
                type: 'email',
                value: email,
                onChange: (e) => setEmail(e.target.value),
                style: {
                  width: '100%',
                  padding: '10px',
                  border: '1px solid #ddd',
                  borderRadius: '4px',
                  fontSize: '16px'
                },
                required: true
              })
            ]),
            React.createElement('div', { key: 'password-group', style: { marginBottom: '20px' } }, [
              React.createElement('label', { key: 'password-label', style: { display: 'block', marginBottom: '5px' } }, 'Password:'),
              React.createElement('input', {
                key: 'password-input',
                type: 'password',
                value: password,
                onChange: (e) => setPassword(e.target.value),
                style: {
                  width: '100%',
                  padding: '10px',
                  border: '1px solid #ddd',
                  borderRadius: '4px',
                  fontSize: '16px'
                },
                required: true
              })
            ]),
            React.createElement('button', {
              key: 'submit',
              type: 'submit',
              disabled: loading,
              style: {
                width: '100%',
                padding: '12px',
                backgroundColor: loading ? '#6c757d' : '#007bff',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                fontSize: '16px',
                cursor: loading ? 'not-allowed' : 'pointer'
              }
            }, loading ? 'Logging in...' : 'Login')
          ])
        ]);
      }
      
      // Main App Component
      function App() {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);
        
        useEffect(() => {
          async function checkAuth() {
            try {
              // Try to get user data directly (session may already exist)
              const userData = await apiCall('/api/user');
              console.log('User data:', userData);
              
              if (userData && userData.id) {
                setUser(userData);
              } else {
                console.log('No valid user data received');
              }
            } catch (error) {
              console.log('No active session, showing login');
            } finally {
              setLoading(false);
            }
          }
          checkAuth();
        }, []);
        
        if (loading) {
          return React.createElement('div', {
            style: {
              padding: '20px',
              textAlign: 'center',
              fontFamily: 'Arial, sans-serif'
            }
          }, [
            React.createElement('h1', { key: 'title' }, 'TheAgencyIQ'),
            React.createElement('p', { key: 'subtitle' }, 'Social Media Automation Platform'),
            React.createElement('div', {
              key: 'loading',
              style: {
                background: 'linear-gradient(135deg, #3250fa, #00f0ff)',
                padding: '20px',
                borderRadius: '10px',
                marginTop: '20px',
                color: 'white'
              }
            }, 'Loading...')
          ]);
        }
        
        return React.createElement('div', {
          style: {
            minHeight: '100vh',
            fontFamily: 'Arial, sans-serif',
            backgroundColor: '#f5f5f5'
          }
        }, [
          React.createElement('header', {
            key: 'header',
            style: {
              background: 'linear-gradient(135deg, #3250fa, #00f0ff)',
              color: 'white',
              padding: '20px',
              textAlign: 'center'
            }
          }, [
            React.createElement('h1', { key: 'title' }, 'TheAgencyIQ'),
            React.createElement('p', { key: 'subtitle' }, 'Social Media Automation Platform')
          ]),
          React.createElement('main', { key: 'main' }, 
            user ? 
              React.createElement(Dashboard, { user }) : 
              React.createElement(Login, { onLogin: setUser })
          )
        ]);
      }
      
      // Initialize React app
      try {
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error('Root element not found');
        }
        
        console.log('🚀 Starting TheAgencyIQ React app...');
        const root = createRoot(rootElement);
        root.render(React.createElement(App));
        console.log('✅ TheAgencyIQ React app mounted successfully');
      } catch (error) {
        console.error('❌ React app mount failed:', error);
        document.getElementById('root').innerHTML = `
          <div style="padding: 20px; text-align: center; font-family: Arial, sans-serif;">
            <h1>Loading Error</h1>
            <p>React app failed to mount: ${error.message}</p>
            <p>Please refresh the page or contact support.</p>
          </div>
        `;
      }
    </script>
    <!-- Replit banner script disabled to prevent HTML injection in API responses -->
    <!-- <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script> -->
  </body>
</html>