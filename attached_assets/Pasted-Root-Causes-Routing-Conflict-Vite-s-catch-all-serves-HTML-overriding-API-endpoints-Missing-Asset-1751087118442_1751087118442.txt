Root Causes:
Routing Conflict: Viteâ€™s catch-all serves HTML, overriding API endpoints.
Missing Assets: beacon.js absence triggers 500 in prior setups.
Configuration Drift: URL changes (e.g., /facebook-data-deletion to /facebook/data-deletion) broke alignment.
Clean Solution:
Principle 1: Single Path: Use /facebook with query params to differentiate.
Principle 2: Fault Tolerance: Handle all errors gracefully.
Principle 3: Asset Integrity: Ensure all referenced files exist.
Surgical Replit Fix
Rewrite server/index.ts
Focus on stability and asset handling:
javascript

Collapse

Wrap

Run

Copy
const express = require('express');
const bodyParser = require('body-parser');
const path = require('path');
const app = express();
const baseUrl = process.env.NODE_ENV === 'production'
  ? 'https://app.theagencyiq.ai'
  : 'https://4fc77172-459a-4da7-8c33-5014abb1b73e-00-dqhtnud4ismj.worf.replit.dev';

// Middleware
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());

// Unified Facebook Endpoint
app.all('/facebook', (req, res) => {
  try {
    const { code, signed_request, action } = { ...req.body, ...req.query };
    if (code) {
      // OAuth callback
      res.status(200).json({ message: 'OAuth received', code });
    } else if (signed_request && (action === 'deletion' || !action)) {
      // Data deletion
      if (!signed_request) throw new Error('No signed_request');
      res.status(200).json({
        url: `${baseUrl}/deletion-status`,
        confirmation_code: 'del_' + Math.random().toString(36).substr(2, 9)
      });
    } else {
      throw new Error('Invalid Facebook request');
    }
  } catch (error) {
    console.error('Facebook Error:', error.stack);
    res.status(500).json({ error: 'Server error', details: process.env.NODE_ENV === 'development' ? error.message : undefined });
  }
});

// Static File Serving
const publicDir = path.join(__dirname, 'dist', 'public');
app.use(express.static(publicDir));
app.get('/manifest.json', (req, res) => {
  res.sendFile(path.join(publicDir, 'manifest.json'), (err) => {
    if (err) res.status(404).json({ error: 'Manifest not found' });
  });
});
app.get('/public/js/beacon.js', (req, res) => {
  res.set('Access-Control-Allow-Origin', '*');
  res.sendFile(path.join(publicDir, 'js', 'beacon.js'), (err) => {
    if (err) res.status(404).json({ error: 'Beacon not found' });
  });
});
app.get('*', (req, res) => res.status(404).json({ error: 'Not found' }));

// Global Error Handler
process.on('uncaughtException', (error) => {
  console.error('Uncaught:', error.stack);
});

const PORT = 5000;
app.listen(PORT, () => console.log(`Live on ${PORT}`));
Install: npm install express body-parser.
Address Missing beacon.js
Since dist/public/js/ is empty (from ls -la), either:
Add File: Create public/js/beacon.js with minimal content (e.g., console.log('Beacon loaded');) and rebuild.
Remove Reference: Delete app.get('/public/js/beacon.js', ...) if unused, avoiding 500.
Fix Routing
Ensure /facebook precedes catch-all, avoiding Vite interference. The current setup prioritizes it correctly.
Rebuild and Deploy
Rebuild: npm run build.
Update .replit if needed:
plaintext

Collapse

Wrap

Copy
run = "node dist/index.js"
Restart server in Replit.