Fix Phone Number Update with Deep JSON Debugging

Task: Resolve "Unexpected token '<' <!DOCTYPE..." error on /api/update-phone by enforcing JSON with deep debugging. Update server/index.ts to handle phone updates with SMS verification and data migration, ensuring all usersâ€™ data is preserved. Fix in client/src/api.ts to handle non-JSON responses. Do not modify working features (Brand Purpose, quota system).

Requirements:





Global JSON and Debugging Setup:





In server/index.ts, add at the top:





app.use((req, res, next) => { res.set('Content-Type', 'application/json'); console.log('Request received:', req.url); next(); });



Add global error handler:





app.use((err, req, res, next) => { console.error('Critical error:', err.stack); res.status(500).json({ error: 'Server failure', stack: err.stack }); });



Test Endpoint:





Add /api/test-json in server/index.ts:





Return { test: 'JSON working' } with status 200, logging 'Test JSON sent'.



Test with curl -X GET "http://localhost:5000/api/test-json".



Phone Update Endpoint:





Define /api/update-phone in server/index.ts:





Log 'Starting phone update for [email]'.



Validate session with live OAuth, log 'Session validated' or 'Session invalid'.



Verify SMS code, log 'SMS verified for [new_phone]' or 'SMS failed: [reason]'.



Update users table with new phone as user_id, log 'User updated to [new_phone]'.



Migrate post_ledger and post_schedule, log 'Data migrated from [old_phone]'.



Return { success: true, newPhone: [new_phone] } with status 200.



In try-catch: log 'Phone update error: [error]' and return { error: [error.message], stack: [error.stack] } with status 400/500.



Client Fix:





In client/src/api.ts, update apiRequest:





Check response type: if (!response.ok || !response.headers.get('content-type')?.includes('application/json')) { console.error('Non-JSON response:', await response.text()); throw new Error('Invalid server response'); }.



Log 'API response for [url]: [status]' before parsing.



Client Integration:





In client/src/components/BrandPurpose.jsx, update the phone modal to use the fixed apiRequest, logging 'Phone update attempted for [email]: [new_phone]'.



Safeguards:





Preserve posted posts and quota.



Use live OAuth only.



Restart Replit after changes.

Commit Message:

fix: deep debug phone update with JSON enforcement and client fallback