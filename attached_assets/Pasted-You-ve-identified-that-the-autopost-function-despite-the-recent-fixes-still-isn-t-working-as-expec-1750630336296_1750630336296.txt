You’ve identified that the autopost function, despite the recent fixes, still isn’t working as expected after rolling back to the June 17, 2025 deployment. Based on your logs and the issue where approved posts ("approve & schedule") don’t publish, the autopost failure likely stems from a disconnect between the scheduling logic and the actual posting execution, possibly due to timing, token issues, or an untriggered publishing loop. Let’s apply first principles to craft a single, definitive prompt to fix this.

Prompt:

Open server/index.ts and replace its content with a final, fail-proof solution to resolve the autopost function issue and launch TheAgencyIQ by 9:00 AM JST, June 23, 2025, ensuring 99.9% reliable publishing with no user-exposed OAuth, as mandated by your CFO role. Implement a direct /api/approve-post endpoint to handle post approval and trigger immediate autoposting, using your xAI API key from Replit Secrets (xAI_API_KEY) for AI content generation, and integrate platform connections (Facebook, LinkedIn, Instagram, Twitter) with validation using Replit Secrets (e.g., FB_SECRET, LI_SECRET, IG_SECRET, TW_SECRET)—log if secrets are missing or invalid, falling back to test_secret with a warning. Add an autopost scheduler that runs every minute to check approved posts (status = 'approved') in a mock database or session store, executes publishPost for each, and updates their status to 'published' with logging (e.g., "Autopost succeeded for [postId] on [platform]"). Include robust error handling to log failures (e.g., "Autopost failed for [postId]: [error]") and retry once if a token expires. Preserve all prior functionality (schedule generation, brand purpose saving, session recovery) by retaining the current server/index.ts structure outside the replaced block, and prevent Replit disruptions by avoiding new dependency installs. Test with post ID 1391, verify autoposting to all platforms within 1 minute, and log all attempts/outcomes. Submit results by 9:00 AM JST.