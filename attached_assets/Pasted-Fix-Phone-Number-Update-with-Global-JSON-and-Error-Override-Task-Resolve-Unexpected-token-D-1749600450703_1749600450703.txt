Fix Phone Number Update with Global JSON and Error Override

Task: Resolve "Unexpected token '<' <!DOCTYPE..." error on /api/update-phone by enforcing JSON responses globally and isolating the failure. Update server/index.ts to handle phone updates with SMS verification and data migration, ensuring all usersâ€™ data is preserved. Do not modify working features (Brand Purpose, quota system).

Requirements:





Global JSON Enforcement:





In server/index.ts, add a top-level middleware:





app.use((req, res, next) => { res.set('Content-Type', 'application/json'); next(); });



Add a global error handler:





app.use((err, req, res, next) => { console.error('Global error:', err.stack); res.status(500).json({ error: 'Server error', details: err.message }); });



Endpoint Definition:





Define /api/update-phone in server/index.ts:





Validate session with live OAuth, logging 'Session check for [email]'.



Verify new phone with SMS code, logging 'SMS verified for [email]: [new_phone]' or 'SMS verification failed: [reason]'.



Update users table with new phone as user_id, logging 'User updated to [new_phone] for [email]'.



Migrate post_ledger and post_schedule to new user_id, logging 'Data migrated from [old_phone] to [new_phone]'.



Return { success: true, newPhone: [new_phone] } with status 200 on success.



Use try-catch: log 'Phone update error for [email]: [error]' and return { error: 'Update failed', details: [error.message] } with status 400/500.



Client Integration:





In client/src/components/BrandPurpose.jsx, update the phone edit modal to send { newPhone, verificationCode } to /api/update-phone, logging 'Update sent for [email]: [new_phone]'.



Handle JSON errors, showing 'Error: [details]' to the user.



Debugging:





Add detailed logging at each step (session, SMS, DB update, migration).



Test with minimal payload to isolate: curl -X POST "http://localhost:5000/api/update-phone" -H "Content-Type: application/json" --cookie cookies.txt -d '{"newPhone": "+610424835189", "verificationCode": "123456"}'.



Safeguards:





Preserve posted posts and quota.



Use live OAuth only.



Restart Replit server after changes.

Commit Message:

fix: enforce global JSON with error override for phone update