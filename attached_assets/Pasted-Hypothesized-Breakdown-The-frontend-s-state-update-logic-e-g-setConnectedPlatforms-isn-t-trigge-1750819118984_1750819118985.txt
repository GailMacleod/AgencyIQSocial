Hypothesized Breakdown:
The frontend’s state update logic (e.g., setConnectedPlatforms) isn’t triggered or incorrectly interprets the wasConnected value.
The button’s conditional rendering might rely on a stale local state rather than the API response.
The resetState action might not invert the state correctly due to a logic error.
Root Cause:
The UI fails to toggle connectedPlatforms[platform] to false after a disconnect when wasConnected is false, because the current logic assumes a prior connection. The button state is stuck due to a misaligned state transition.
Surgical Fix:
We’ll adjust the backend response to explicitly set the new state and provide a refined frontend hint to enforce the correct toggle.

Prompt:

{
"action": "replace",
"file": "server/index.ts",
"target": {
"endpoint": "/api/disconnect-platform"
},
"content": {
"disconnectEndpoint": {
"code": "app.post('/api/disconnect-platform', async (req, res) => {\n  const userId = req.session.userId || 2;\n  const { platform } = req.body;\n  const validPlatforms = ['facebook', 'instagram', 'linkedin', 'x', 'youtube'];\n  if (!platform || !validPlatforms.includes(platform.toLowerCase())) {\n    return res.status(400).json({"error": "Invalid platform", "validPlatforms": validPlatforms});\n  }\n  const wasConnected = req.session.connectedPlatforms && req.session.connectedPlatforms[platform.toLowerCase()];\n  req.session.connectedPlatforms = req.session.connectedPlatforms || {};\n  req.session.connectedPlatforms[platform.toLowerCase()] = false; // Explicitly set disconnected\n  fs.writeFileSync('connected-platforms.json', JSON.stringify(req.session.connectedPlatforms));\n  console.log(Set ${platform} to disconnected for user ${userId});\n  res.json({"success": true, "platform": platform.toLowerCase(), "message": "Disconnected successfully", "action": "updateState", "isConnected": false, "version": "1.2"});\n});"
}
},
"instructions": {
"run": "NODE_ENV=production tsx server/index.ts",
"test": {
"url": "https://app.theagencyiq.ai/connect",
"action": "Click disconnect for Facebook and Instagram, verify button changes to 'Connect' and console logs 'Set to disconnected'",
"submit": "Submit results immediately"
},
"notes": {
"frontendHint": "Update connect.tsx: Modify the disconnect handler: const handleDisconnect = async (plat) => { const res = await fetch(/api/disconnect-platform, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({platform: plat}) }); const data = await res.json(); if (data.action === 'updateState' && data.version === '1.2') setConnectedPlatforms(prev => ({ ...prev, [data.platform]: data.isConnected })); }; Call handleDisconnect on button click.",
"noDisruption": "Only updates /api/disconnect-platform, no OAuth logic altered."
}
}
}