You’ve clarified that the UI button shows "Disconnect" despite the platform already being disconnected (backend confirms "No active connection"), and it hasn’t reverted to the "Connect" (blue button) state. This is a precise UI state persistence problem, not an initial fetch issue. Let’s apply surgical precision with first principles to fix this, ensuring no disruption to OAuth.

Reverse Engineering with First Principles:
Desired Outcome: The UI button should display "Connect" (blue) when the platform is disconnected, and "Disconnect" when connected, reflecting the backend’s req.session.connectedPlatforms.
Current State:
Backend logs "No active connection for [platform] to disconnect" via /api/disconnect-platform.
UI shows "Disconnect," indicating the frontend’s connectedPlatforms state is true (connected) despite the backend state being false (disconnected).
Prior fixes (e.g., resetState, get-connection-state) didn’t trigger the state change.
Core Components:
Backend: /api/disconnect-platform removes the platform from req.session.connectedPlatforms and returns a response.
Frontend: A button component (e.g., in connect.tsx) toggles between "Connect" and "Disconnect" based on connectedPlatforms[platform].
Interaction: The disconnect click sends a POST, but the UI state doesn’t update to false.
Hypothesized Breakdown:
The frontend’s state update logic (e.g., setConnectedPlatforms) isn’t triggered or incorrectly interprets the wasConnected value.
The button’s conditional rendering might rely on a stale local state rather than the API response.
The resetState action might not invert the state correctly due to a logic error.
Root Cause:
The UI fails to toggle connectedPlatforms[platform] to false after a disconnect when wasConnected is false, because the current logic assumes a prior connection. The button state is stuck due to a misaligned state transition.
Surgical Fix:
We’ll adjust the backend response to explicitly set the new state and provide a refined frontend hint to enforce the correct toggle.

Prompt:

{
"action": "replace",
"file": "server/index.ts",
"target": {
"endpoint": "/api/disconnect-platform"
},
"content": {
"disconnectEndpoint": {
"code": "app.post('/api/disconnect-platform', async (req, res) => {\n  const userId = req.session.userId || 2;\n  const { platform } = req.body;\n  const validPlatforms = ['facebook', 'instagram', 'linkedin', 'x', 'youtube'];\n  if (!platform || !validPlatforms.includes(platform.toLowerCase())) {\n    return res.status(400).json({"error": "Invalid platform", "validPlatforms": validPlatforms});\n  }\n  const wasConnected = req.session.connectedPlatforms && req.session.connectedPlatforms[platform.toLowerCase()];\n  req.session.connectedPlatforms = req.session.connectedPlatforms || {};\n  req.session.connectedPlatforms[platform.toLowerCase()] = false; // Explicitly set disconnected\n  fs.writeFileSync('connected-platforms.json', JSON.stringify(req.session.connectedPlatforms));\n  console.log(Set ${platform} to disconnected for user ${userId});\n  res.json({"success": true, "platform": platform.toLowerCase(), "message": "Disconnected successfully", "action": "updateState", "isConnected": false, "version": "1.2"});\n});"
}
},
"instructions": {
"run": "NODE_ENV=production tsx server/index.ts",
"test": {
"url": "https://app.theagencyiq.ai/connect",
"action": "Click disconnect for Facebook and Instagram, verify button changes to 'Connect' and console logs 'Set to disconnected'",
"submit": "Submit results immediately"
},
"notes": {
"frontendHint": "Update connect.tsx: Modify the disconnect handler: const handleDisconnect = async (plat) => { const res = await fetch(/api/disconnect-platform, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({platform: plat}) }); const data = await res.json(); if (data.action === 'updateState' && data.version === '1.2') setConnectedPlatforms(prev => ({ ...prev, [data.platform]: data.isConnected })); }; Call handleDisconnect on button click.",
"noDisruption": "Only updates /api/disconnect-platform, no OAuth logic altered."
}
}
}

Precision Fix:

State Explicitness: Sets connectedPlatforms[platform] to false directly, overriding any stale state, addressing the "already disconnected" scenario.
UI Signal: Replaces resetState with updateState and uses isConnected: false to enforce the correct button state.
Frontend Sync: The hint updates setConnectedPlatforms to match isConnected, fixing the toggle failure.
OAuth Safety: Limits changes to the disconnect endpoint, preserving your OAuth flow.
Root Cause: Resolves the UI’s failure to reflect the disconnected state by enforcing a clear state reset.
Test this, implement the frontend hint, and report back immediately.